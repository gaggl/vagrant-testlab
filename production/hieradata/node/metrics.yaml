---
classes:
 - roles::metrics
profiles::metrics::grafana: true
profiles::metrics::grafana::datasources:
  prometheus:
    is_default: true
    type: prometheus
    url: 'http://prometheus.gaggl.vagrant'
    access_mode: proxy
profiles::metrics::grafana::manage_repo: true
profiles::monitoring::prometheus::scrape_configs:
  - job_name: prometheus
    scrape_interval: 10s
    scrape_timeout: 10s
    static_configs:
    - targets:
        - prometheus.gaggl.vagrant:9090
  - job_name: consul
    scrape_interval: 10s
    scrape_timeout: 10s
    consul_sd_configs:
      - server: 'localhost:8500'
        services:
          - node_exporter
    relabel_configs:
      - source_labels: [__meta_consul_tags]
        regex: '.*,hostname=([^,]+),.*'
        replacement: '${1}'
        target_label: 'hostname'
      - source_labels: [__meta_consul_tags]
        regex: '.*,environment=([^,]+),.*'
        replacement: '${1}'
        target_label: 'environment'
profiles::monitoring::prometheus::server: true
profiles::website::nginx: true
profiles::website::nginx::vhosts:
  grafana.gaggl.vagrant:
    proxy: 'http://127.0.0.1:3000'
  prometheus.gaggl.vagrant:
    proxy:  'http://127.0.0.1:9090'
